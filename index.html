<!DOCTYPE html>
<html>
<head>
    <title>Огоньки веры</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        #map { 
            height: 100vh; 
            background: #1a1a2e;
        }
        body { 
            margin: 0; 
            font-family: Arial; 
        }
        
        .star-icon {
            filter: drop-shadow(0 0 3px rgba(255, 255, 255, 0.6));
            text-shadow: 0 0 4px rgba(255, 255, 255, 0.8);
            font-size: 20px;
            animation: gentle-glow 4s ease-in-out infinite;
        }
        
        @keyframes gentle-glow {
            0% { 
                filter: drop-shadow(0 0 2px rgba(255, 255, 255, 0.4));
                text-shadow: 0 0 3px rgba(255, 255, 255, 0.6);
            }
            50% { 
                filter: drop-shadow(0 0 4px rgba(255, 255, 255, 0.7));
                text-shadow: 0 0 5px rgba(255, 255, 255, 0.9);
            }
            100% { 
                filter: drop-shadow(0 0 2px rgba(255, 255, 255, 0.4));
                text-shadow: 0 0 3px rgba(255, 255, 255, 0.6);
            }
        }
        
        .stats {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 15px;
            border-radius: 10px;
            z-index: 1000;
            border: 1px solid gold;
            backdrop-filter: blur(5px);
        }
        
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: gold;
            padding: 20px;
            border-radius: 10px;
            z-index: 1000;
            border: 1px solid gold;
        }
        
        /* Стили для сообщения о задержке */
        #cooldownMessage {
            position: fixed;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 215, 0, 0.95);
            color: #333;
            padding: 12px 24px;
            border-radius: 25px;
            z-index: 10000;
            font-weight: bold;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            border: 2px solid gold;
            animation: slideDown 0.3s ease-out;
        }
        
        @keyframes slideDown {
            from { transform: translateX(-50%) translateY(-20px); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }
        
        @keyframes slideUp {
            from { transform: translateX(-50%) translateY(0); opacity: 1; }
            to { transform: translateX(-50%) translateY(-20px); opacity: 0; }
        }
    </style>
</head>
<body>
    <div class="stats">
        <strong>✨ Огоньки веры в чудо</strong><br>
        Всего огней: <span id="fireCount">0</span>
    </div>

    <div id="loadingMessage" class="loading" style="display: none;">
        Загружаем огни... ✨
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Твой API URL
        const API_URL = 'https://script.google.com/macros/s/AKfycbxUF6JdqzFvFVsF-YFuweyt_5EKKg4SCGHEbC7qjFTBSHclvr5mVVA5i5Z2HMfUxbA/exec';
        
        // НАСТРОЙКИ ЗАДЕРЖКИ
        let lastClickTime = 0;
        const CLICK_DELAY = 60000; // 1 минута в миллисекундах
        let userId = localStorage.getItem('userFireId');

        // Создаем уникальный ID для этого браузера, если его нет
        if (!userId) {
            userId = 'user_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('userFireId', userId);
        }

        // Инициализация карты
        const map = L.map('map').setView([55.7558, 37.6173], 3);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '© OpenStreetMap'
        }).addTo(map);

        // Создаём иконку со звёздочкой
        const starIcon = L.divIcon({
            className: 'star-icon',
            html: '✨',
            iconSize: [24, 24],
            iconAnchor: [12, 12]
        });

        // Хранилище для маркеров
        const markers = [];
        let fireCount = 0;

        // Загружаем огни при старте
        loadAllFires();

        // Клик по карте - добавляем огонёк С ПРОВЕРКОЙ ЗАДЕРЖКИ
        map.on('click', function(e) {
            const now = Date.now();
            
            // Проверяем задержку только для этого пользователя
            if (now - lastClickTime < CLICK_DELAY) {
                const secondsLeft = Math.ceil((CLICK_DELAY - (now - lastClickTime)) / 1000);
                showCooldownMessage(secondsLeft);
                return;
            }
            
            lastClickTime = now;
            const { lat, lng } = e.latlng;
            addGlobalFire(lat, lng);
        });

        // Функция красивого сообщения о задержке
        function showCooldownMessage(seconds) {
            // Создаем или находим сообщение
            let msg = document.getElementById('cooldownMessage');
            if (!msg) {
                msg = document.createElement('div');
                msg.id = 'cooldownMessage';
                document.body.appendChild(msg);
            }
            
            msg.innerHTML = `⏳ Подожди ${seconds} сек. перед следующим огоньком ✨`;
            msg.style.display = 'block';
            
            // Авто-исчезновение через 3 секунды
            setTimeout(() => {
                if (msg.parentNode) {
                    msg.style.animation = 'slideUp 0.3s ease-in forwards';
                    setTimeout(() => {
                        msg.style.display = 'none';
                        msg.style.animation = '';
                    }, 300);
                }
            }, 3000);
        }

        // Добавление огня в общую базу
        async function addGlobalFire(lat, lng) {
            // МГНОВЕННО показываем огонёк
            const marker = L.marker([lat, lng], {icon: starIcon}).addTo(map);
            markers.push(marker);
            
            // Обновляем счетчик
            fireCount++;
            updateStats();
            
            // ФОНОВО синхронизируем с сервером
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        lat, 
                        lng, 
                        userId,  // передаем ID пользователя
                        timestamp: Date.now()
                    })
                });
                const result = await response.json();
                console.log('Синхронизировано с сервером:', result.success);
                
                // ОБНОВЛЯЕМ КЕШ после добавления нового огня
                updateCache();
            } catch (error) {
                console.error('Ошибка синхронизации:', error);
            }
        }

        // Обновление кеша без перерисовки карты
        async function updateCache() {
            try {
                const response = await fetch(API_URL + '?t=' + Date.now());
                const fires = await response.json();
                
                // Сохраняем в кеш
                localStorage.setItem('cachedFires', JSON.stringify(fires));
                localStorage.setItem('cacheTime', Date.now());
                
                console.log('Кеш обновлен:', fires.length);
            } catch (error) {
                console.error('Ошибка обновления кеша:', error);
            }
        }

        // Загрузка всех огней С КЕШИРОВАНИЕМ
        async function loadAllFires() {
            // Показываем сообщение о загрузке только при первом открытии
            if (!localStorage.getItem('cachedFires')) {
                document.getElementById('loadingMessage').style.display = 'block';
            }
            
            // Пытаемся взять из кеша сначала
            const cachedFires = localStorage.getItem('cachedFires');
            const cacheTime = localStorage.getItem('cacheTime');
            
            // Если в кеше есть данные младше 2 минут - используем их
            if (cachedFires && cacheTime && (Date.now() - cacheTime < 2 * 60 * 1000)) {
                const fires = JSON.parse(cachedFires);
                showFiresOnMap(fires);
                console.log('Огни из кеша:', fires.length);
                document.getElementById('loadingMessage').style.display = 'none';
                return;
            }
            
            // Если нет - грузим с сервера
            try {
                console.log('Загружаем огни с сервера...');
                const response = await fetch(API_URL + '?t=' + Date.now());
                const fires = await response.json();
                
                // Сохраняем в кеш
                localStorage.setItem('cachedFires', JSON.stringify(fires));
                localStorage.setItem('cacheTime', Date.now());
                
                showFiresOnMap(fires);
                console.log('Огни с сервера:', fires.length);
            } catch (error) {
                console.error('Ошибка загрузки:', error);
                // Если сервер недоступен, показываем кешированные данные даже старые
                if (cachedFires) {
                    const fires = JSON.parse(cachedFires);
                    showFiresOnMap(fires);
                    console.log('Используем старый кеш из-за ошибки:', fires.length);
                }
            }
            
            document.getElementById('loadingMessage').style.display = 'none';
        }

        // Функция отображения огней на карте
        function showFiresOnMap(fires) {
            // Очищаем старые огни
            clearMarkers();
            
            // Добавляем новые
            fires.forEach(fire => {
                const marker = L.marker([fire.lat, fire.lng], {icon: starIcon}).addTo(map);
                markers.push(marker);
            });
            
            fireCount = fires.length;
            updateStats();
        }

        // Функция очистки маркеров
        function clearMarkers() {
            markers.forEach(marker => {
                map.removeLayer(marker);
            });
            markers.length = 0;
        }

        function updateStats() {
            document.getElementById('fireCount').textContent = fireCount;
        }

        // Обновляем кеш каждые 2 минуты
        setInterval(updateCache, 2 * 60 * 1000);
    </script>
</body>
</html>
