<!DOCTYPE html>
<html>
<head>
    <title>Огоньки веры в чудо</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        #map { 
            height: 100vh; 
            background: #1a1a2e;
        }
        body { 
            margin: 0; 
            font-family: Arial; 
        }
        
        .star-icon {
            font-size: 24px;
            filter: drop-shadow(0 0 8px gold);
            animation: glow 2s infinite;
        }
        
        @keyframes glow {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.1); }
        }
        
        .stats {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 15px;
            border-radius: 10px;
            z-index: 1000;
            border: 2px solid gold;
        }
        
        .message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9);
            color: gold;
            padding: 20px;
            border-radius: 10px;
            z-index: 1000;
            border: 2px solid gold;
        }
    </style>
</head>
<body>
    <div class="stats">
        <strong>✨ Огоньки веры</strong><br>
        Огней: <span id="fireCount">0</span>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Простая версия - только основы
        const API_URL = 'https://script.google.com/macros/s/AKfycbxUF6JdqzFvFVsF-YFuweyt_5EKKg4SCGHEbC7qjFTBSHclvr5mVVA5i5Z2HMfUxbA/exec';
        
        // Карта
        const map = L.map('map').setView([55.7558, 37.6173], 3);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
        
        // Иконка
        const starIcon = L.divIcon({
            className: 'star-icon',
            html: '✨',
            iconSize: [30, 30]
        });

        let markers = [];
        let fireCount = 0;

        // Загружаем огни
        loadFires();

        // Клик по карте
        map.on('click', async function(e) {
            const { lat, lng } = e.latlng;
            
            // Сразу показываем огонёк
            const marker = L.marker([lat, lng], {icon: starIcon}).addTo(map);
            markers.push(marker);
            fireCount++;
            updateCount();
            
            // Пробуем сохранить
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({lat, lng})
                });
                console.log('Сохранено!');
            } catch (error) {
                console.log('Ошибка, но огонёк виден');
            }
        });

        // Загрузка огней
        async function loadFires() {
            try {
                const response = await fetch(API_URL);
                const fires = await response.json();
                
                // Очищаем старые
                markers.forEach(marker => map.removeLayer(marker));
                markers = [];
                
                // Добавляем новые
                fires.forEach(fire => {
                    const marker = L.marker([fire.lat, fire.lng], {icon: starIcon}).addTo(map);
                    markers.push(marker);
                });
                
                fireCount = fires.length;
                updateCount();
                
            } catch (error) {
                console.log('Не удалось загрузить огни');
            }
        }

        function updateCount() {
            document.getElementById('fireCount').textContent = fireCount;
        }

        // Обновляем каждые 30 секунд
        setInterval(loadFires, 30000);
    </script>
</body>
</html>
