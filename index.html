<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–û–≥–æ–Ω—å–∫–∏ –≤–µ—Ä—ã –≤ —á—É–¥–æ</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: #0a0a1a;
            color: white;
            overflow: hidden;
        }

        #map {
            height: 100vh;
            width: 100%;
            background: #1a1a2e;
        }

        .header {
            position: absolute;
            top: 15px;
            left: 15px;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px 20px;
            border-radius: 15px;
            border: 2px solid #FFD700;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 20px rgba(255, 215, 0, 0.3);
        }

        .header h1 {
            font-size: 18px;
            margin-bottom: 8px;
            color: #FFD700;
        }

        .stats {
            font-size: 14px;
        }

        .fire-count {
            color: #FFD700;
            font-weight: bold;
            font-size: 16px;
        }

        .instructions {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            padding: 12px 20px;
            border-radius: 10px;
            border: 1px solid #FFD700;
            z-index: 1000;
            font-size: 14px;
            text-align: center;
            backdrop-filter: blur(5px);
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –∑–≤—ë–∑–¥–æ—á–µ–∫ */
        .star-icon {
            font-size: 24px;
            filter: drop-shadow(0 0 8px rgba(255, 215, 0, 0.8));
            animation: gentle-glow 2s ease-in-out infinite alternate;
        }

        @keyframes gentle-glow {
            0% {
                filter: drop-shadow(0 0 4px rgba(255, 215, 0, 0.6));
                transform: scale(1);
            }
            100% {
                filter: drop-shadow(0 0 12px rgba(255, 215, 0, 1));
                transform: scale(1.1);
            }
        }

        /* –°–æ–æ–±—â–µ–Ω–∏—è */
        .message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.95);
            color: #FFD700;
            padding: 20px 30px;
            border-radius: 15px;
            border: 2px solid #FFD700;
            z-index: 10000;
            font-size: 16px;
            text-align: center;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.5);
            backdrop-filter: blur(10px);
        }

        .error {
            border-color: #ff4444;
            color: #ff4444;
        }

        .success {
            border-color: #44ff44;
            color: #44ff44;
        }

        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            color: #FFD700;
            padding: 25px;
            border-radius: 15px;
            border: 2px solid #FFD700;
            z-index: 1000;
            font-size: 16px;
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-width: 768px) {
            .header {
                top: 10px;
                left: 10px;
                right: 10px;
                text-align: center;
            }
            
            .instructions {
                bottom: 10px;
                left: 10px;
                right: 10px;
                transform: none;
            }
        }
    </style>
</head>
<body>
    <!-- –®–∞–ø–∫–∞ —Å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π -->
    <div class="header">
        <h1>‚ú® –û–≥–æ–Ω—å–∫–∏ –≤–µ—Ä—ã –≤ —á—É–¥–æ</h1>
        <div class="stats">
            –í—Å–µ–≥–æ –æ–≥–Ω–µ–π: <span class="fire-count" id="fireCount">0</span>
        </div>
    </div>

    <!-- –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è -->
    <div class="instructions">
        –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É –≤ –ª—é–±–æ–º –º–µ—Å—Ç–µ, —á—Ç–æ–±—ã –æ—Å—Ç–∞–≤–∏—Ç—å –æ–≥–æ–Ω—ë–∫ –≤–µ—Ä—ã ‚ú®
    </div>

    <!-- –ö–∞—Ä—Ç–∞ -->
    <div id="map"></div>

    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Leaflet -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
        const CONFIG = {
            API_URL: 'https://script.google.com/macros/s/AKfycbxUF6JdqzFvFVsF-YFuweyt_5EKKg4SCGHEbC7qjFTBSHclvr5mVVA5i5Z2HMfUxbA/exec',
            CACHE_DURATION: 30 * 1000,
            AUTO_REFRESH: 30 * 1000,
            INITIAL_VIEW: [55.7558, 37.6173],
            INITIAL_ZOOM: 3
        };

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let map;
        let currentMarkers = [];
        let fireCount = 0;
        let lastUpdateTime = 0;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            initializeMap();
            loadFires();
            setInterval(quickCheckForNewFires, CONFIG.AUTO_REFRESH);
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã
        function initializeMap() {
            map = L.map('map').setView(CONFIG.INITIAL_VIEW, CONFIG.INITIAL_ZOOM);
            
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '¬© OpenStreetMap'
            }).addTo(map);

            map.on('click', function(e) {
                addFire(e.latlng.lat, e.latlng.lng);
            });
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –∏–∫–æ–Ω–∫–∏ –∑–≤–µ–∑–¥—ã
        function createStarIcon() {
            return L.divIcon({
                className: 'star-icon',
                html: '‚ú®',
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            });
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ–≥–æ–Ω—å–∫–∞
        async function addFire(lat, lng) {
            // –°—Ä–∞–∑—É –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–≥–æ–Ω—ë–∫ –ª–æ–∫–∞–ª—å–Ω–æ
            addMarkerToMap(lat, lng);
            updateLocalStorage(lat, lng);
            updateFireCount(fireCount + 1);
            
            showMessage("–°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–≥–æ–Ω—ë–∫... ‚ú®");
            
            try {
                // –ü—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã –¥–∞–Ω–Ω—ã—Ö –¥–ª—è Google Apps Script
                const result = await saveToServer(lat, lng);
                console.log('–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', result);
                
                if (result && result.status === 'success') {
                    showMessage("–û–≥–æ–Ω—ë–∫ —Å–æ—Ö—Ä–∞–Ω—ë–Ω! üåü", 1500, 'success');
                } else {
                    // –ï—Å–ª–∏ –Ω–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —É—Å–ø–µ—Ö, –Ω–æ –æ—Ç–≤–µ—Ç –µ—Å—Ç—å - —Å—á–∏—Ç–∞–µ–º —É—Å–ø–µ—Ö–æ–º
                    showMessage("–û–≥–æ–Ω—ë–∫ —Å–æ—Ö—Ä–∞–Ω—ë–Ω! üåü", 1500, 'success');
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);
                showMessage("–û–≥–æ–Ω—ë–∫ –¥–æ–±–∞–≤–ª–µ–Ω –ª–æ–∫–∞–ª—å–Ω–æ üåü", 2000, 'success');
            }
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä - –ü–†–û–ë–£–ï–ú –†–ê–ó–ù–´–ï –§–û–†–ú–ê–¢–´
        async function saveToServer(lat, lng) {
            // –§–æ—Ä–º–∞—Ç 1: –ü—Ä–æ—Å—Ç–æ–π –æ–±—ä–µ–∫—Ç
            const payload1 = { lat: lat, lng: lng };
            
            // –§–æ—Ä–º–∞—Ç 2: –° –¥–∞—Ç–æ–π –∏ –≤—Ä–µ–º–µ–Ω–µ–º
            const payload2 = {
                latitude: lat,
                longitude: lng,
                timestamp: new Date().toISOString()
            };
            
            // –§–æ—Ä–º–∞—Ç 3: –ö–∞–∫ –º–∞—Å—Å–∏–≤ (–¥–ª—è Google Sheets)
            const payload3 = [[lat, lng, new Date().toISOString()]];
            
            // –ü—Ä–æ–±—É–µ–º –≤—Å–µ —Ñ–æ—Ä–º–∞—Ç—ã –ø–æ –æ—á–µ—Ä–µ–¥–∏
            const payloads = [payload1, payload2, payload3];
            
            for (let payload of payloads) {
                try {
                    console.log('–ü—Ä–æ–±—É–µ–º payload:', payload);
                    
                    const response = await fetch(CONFIG.API_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(payload)
                    });
                    
                    const result = await response.text();
                    console.log('Raw response:', result);
                    
                    // –ü—Ä–æ–±—É–µ–º —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON
                    try {
                        return JSON.parse(result);
                    } catch {
                        // –ï—Å–ª–∏ –Ω–µ JSON, –Ω–æ –æ—Ç–≤–µ—Ç 200 - —Å—á–∏—Ç–∞–µ–º —É—Å–ø–µ—Ö–æ–º
                        if (response.ok) {
                            return { status: 'success' };
                        }
                    }
                    
                } catch (error) {
                    console.log('–§–æ—Ä–º–∞—Ç –Ω–µ –ø–æ–¥–æ—à–µ–ª, –ø—Ä–æ–±—É–µ–º —Å–ª–µ–¥—É—é—â–∏–π...');
                    continue;
                }
            }
            
            throw new Error('–í—Å–µ —Ñ–æ—Ä–º–∞—Ç—ã –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–∏');
        }

        // –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–æ–≤—ã—Ö –æ–≥–æ–Ω—å–∫–æ–≤
        async function quickCheckForNewFires() {
            if (Date.now() - lastUpdateTime < 60 * 1000) return;
            
            try {
                const fires = await loadFromServer();
                if (fires && fires.length > fireCount) {
                    displayFires(fires);
                    saveToCache(fires);
                }
            } catch (error) {
                console.log('–ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: –Ω–µ—Ç –Ω–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö');
            }
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–∞ –Ω–∞ –∫–∞—Ä—Ç—É
        function addMarkerToMap(lat, lng) {
            const marker = L.marker([lat, lng], { 
                icon: createStarIcon() 
            }).addTo(map);
            currentMarkers.push(marker);
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
        function updateLocalStorage(lat, lng) {
            const cachedData = getCachedFires();
            const fires = cachedData?.fires || [];
            fires.push({ lat, lng });
            
            localStorage.setItem('cachedFires', JSON.stringify({
                fires: fires,
                timestamp: Date.now()
            }));
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –æ–≥–æ–Ω—å–∫–æ–≤
        async function loadFires() {
            showLoading(true);
            
            const cachedData = getCachedFires();
            if (cachedData && isCacheValid(cachedData.timestamp)) {
                displayFires(cachedData.fires);
                showLoading(false);
                setTimeout(checkFreshData, 1000);
                return;
            }
            
            try {
                const fires = await loadFromServer();
                if (fires && Array.isArray(fires)) {
                    displayFires(fires);
                    saveToCache(fires);
                    lastUpdateTime = Date.now();
                } else {
                    throw new Error('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
                if (cachedData) {
                    displayFires(cachedData.fires);
                }
            }
            
            showLoading(false);
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å —Å–µ—Ä–≤–µ—Ä–∞ —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫
        async function loadFromServer() {
            try {
                const response = await fetch(CONFIG.API_URL + '?action=get&t=' + Date.now());
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã –æ—Ç–≤–µ—Ç–∞
                if (Array.isArray(data)) {
                    return data;
                } else if (data.data && Array.isArray(data.data)) {
                    return data.data;
                } else if (data.fires && Array.isArray(data.fires)) {
                    return data.fires;
                } else {
                    console.warn('–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:', data);
                    return [];
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å —Å–µ—Ä–≤–µ—Ä–∞:', error);
                throw error;
            }
        }

        // –§–æ–Ω–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–≤–µ–∂–∏—Ö –¥–∞–Ω–Ω—ã—Ö
        async function checkFreshData() {
            try {
                const freshFires = await loadFromServer();
                const cachedData = getCachedFires();
                
                if (freshFires.length > (cachedData?.fires?.length || 0)) {
                    displayFires(freshFires);
                    saveToCache(freshFires);
                }
            } catch (error) {
                // –¢–∏—Ö–∞—è –æ—à–∏–±–∫–∞
            }
        }

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        function getCachedFires() {
            const cached = localStorage.getItem('cachedFires');
            return cached ? JSON.parse(cached) : null;
        }

        function isCacheValid(timestamp) {
            return Date.now() - timestamp < CONFIG.CACHE_DURATION;
        }

        function saveToCache(fires) {
            localStorage.setItem('cachedFires', JSON.stringify({
                fires: fires,
                timestamp: Date.now()
            }));
        }

        function displayFires(fires) {
            if (!fires || !Array.isArray(fires)) return;
            
            clearMarkers();
            fires.forEach(fire => {
                if (fire.lat && fire.lng) {
                    addMarkerToMap(fire.lat, fire.lng);
                }
            });
            updateFireCount(fires.length);
        }

        function clearMarkers() {
            currentMarkers.forEach(marker => map.removeLayer(marker));
            currentMarkers = [];
        }

        function updateFireCount(count) {
            fireCount = count;
            document.getElementById('fireCount').textContent = count;
        }

        function showLoading(show) {
            let loading = document.getElementById('loading');
            if (show && !loading) {
                loading = document.createElement('div');
                loading.id = 'loading';
                loading.className = 'loading';
                loading.textContent = '–ó–∞–≥—Ä—É–∂–∞–µ–º –æ–≥–Ω–∏... ‚ú®';
                document.body.appendChild(loading);
            } else if (!show && loading) {
                loading.remove();
            }
        }

        function showMessage(text, duration = 3000, type = '') {
            const message = document.createElement('div');
            message.className = `message ${type}`;
            message.textContent = text;
            document.body.appendChild(message);
            
            setTimeout(() => {
                if (message.parentNode) {
                    message.parentNode.removeChild(message);
                }
            }, duration);
        }
    </script>
</body>
</html>
