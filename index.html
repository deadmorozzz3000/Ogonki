<!DOCTYPE html>
<html>
<head>
    <title>Огоньки веры в чудо</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        #map { 
            height: 100vh; 
            background: #1a1a2e;
        }
        body { 
            margin: 0; 
            font-family: Arial; 
        }
        
        .star-icon {
            filter: drop-shadow(0 0 8px rgba(255, 255, 255, 0.9));
            text-shadow: 0 0 12px rgba(255, 255, 255, 1);
            font-size: 24px;
            animation: gentle-glow 3s ease-in-out infinite;
        }
        
        @keyframes gentle-glow {
            0% { 
                filter: drop-shadow(0 0 4px rgba(255, 255, 255, 0.7));
                text-shadow: 0 0 8px rgba(255, 255, 255, 0.8);
            }
            50% { 
                filter: drop-shadow(0 0 10px rgba(255, 255, 255, 1));
                text-shadow: 0 0 15px rgba(255, 255, 255, 1);
            }
            100% { 
                filter: drop-shadow(0 0 4px rgba(255, 255, 255, 0.7));
                text-shadow: 0 0 8px rgba(255, 255, 255, 0.8);
            }
        }
        
        .stats {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px;
            border-radius: 10px;
            z-index: 1000;
            border: 2px solid #FFD700;
            backdrop-filter: blur(5px);
        }
        
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            color: #FFD700;
            padding: 20px;
            border-radius: 10px;
            z-index: 1000;
            border: 2px solid #FFD700;
        }
    </style>
</head>
<body>
    <div class="stats">
        <strong>✨ Огоньки веры в чудо</strong><br>
        Всего огней: <span id="fireCount">0</span>
    </div>

    <div id="loadingMessage" class="loading" style="display: none;">
        Загружаем огни... ✨
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Твой API URL
        const API_URL = 'https://script.google.com/macros/s/AKfycbxUF6JdqzFvFVsF-YFuweyt_5EKKg4SCGHEbC7qjFTBSHclvr5mVVA5i5Z2HMfUxbA/exec';
        
        // Инициализация карты - ТЁМНАЯ КАРТА С ЯРКИМИ НАДПИСЯМИ
        const map = L.map('map').setView([55.7558, 37.6173], 3);
        
        // Пробуем разные стили с яркими надписями:
        
        // Вариант 1: Тёмная карта с контрастными надписями
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '© OpenStreetMap'
        }).addTo(map);
        
        // Вариант 2 (запасной): Если первый не подходит - раскомментируй эту строку:
        // L.tileLayer('https://tiles.stadiamaps.com/tiles/alidade_smooth_dark/{z}/{x}/{y}{r}.png', {
        //     attribution: '© OpenStreetMap'
        // }).addTo(map);

        // Создаём иконку со звёздочкой
        const starIcon = L.divIcon({
            className: 'star-icon',
            html: '✨',
            iconSize: [30, 30],
            iconAnchor: [15, 15]
        });

        // Храним маркеры отдельно
        let currentMarkers = [];
        let fireCount = 0;

        // Загружаем огни при старте
        loadAllFires();

        // Клик по карте - добавляем огонёк
        map.on('click', function(e) {
            const { lat, lng } = e.latlng;
            addGlobalFire(lat, lng);
        });

        // Добавление огня в общую базу
        async function addGlobalFire(lat, lng) {
            // МГНОВЕННО показываем огонёк
            const newMarker = L.marker([lat, lng], {icon: starIcon}).addTo(map);
            currentMarkers.push(newMarker);
            
            fireCount++;
            updateStats();
            
            // ФОНОВО синхронизируем с сервером
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({lat, lng})
                });
                const result = await response.json();
                console.log('Синхронизировано с сервером:', result.success);
                
            } catch (error) {
                console.error('Ошибка синхронизации:', error);
            }
        }

        // Загрузка всех огней С КЕШИРОВАНИЕМ
        async function loadAllFires() {
            // Показываем сообщение о загрузке только при первом открытии
            if (!localStorage.getItem('cachedFires')) {
                document.getElementById('loadingMessage').style.display = 'block';
            }
            
            // Пытаемся взять из кеша сначала
            const cachedFires = localStorage.getItem('cachedFires');
            const cacheTime = localStorage.getItem('cacheTime');
            
            // Если в кеше есть данные младше 10 минут - используем их
            if (cachedFires && cacheTime && (Date.now() - cacheTime < 10 * 60 * 1000)) {
                const fires = JSON.parse(cachedFires);
                showFiresOnMap(fires);
                console.log('Огни из кеша:', fires.length);
                document.getElementById('loadingMessage').style.display = 'none';
                return;
            }
            
            // Если нет - грузим с сервера
            try {
                console.log('Загружаем огни с сервера...');
                const response = await fetch(API_URL + '?t=' + Date.now());
                const fires = await response.json();
                
                // Сохраняем в кеш
                localStorage.setItem('cachedFires', JSON.stringify(fires));
                localStorage.setItem('cacheTime', Date.now());
                
                showFiresOnMap(fires);
                console.log('Огни с сервера:', fires.length);
            } catch (error) {
                console.error('Ошибка загрузки:', error);
                // Если сервер недоступен, показываем кешированные данные даже старые
                if (cachedFires) {
                    const fires = JSON.parse(cachedFires);
                    showFiresOnMap(fires);
                    console.log('Используем старый кеш из-за ошибки:', fires.length);
                }
            }
            
            document.getElementById('loadingMessage').style.display = 'none';
        }

        // Функция отображения огней на карте
        function showFiresOnMap(fires) {
            // Очищаем только старые маркеры (не те, что добавили в этой сессии)
            currentMarkers.forEach(marker => {
                if (map.hasLayer(marker)) {
                    map.removeLayer(marker);
                }
            });
            currentMarkers = [];
            
            // Добавляем огни из сервера
            fires.forEach(fire => {
                const marker = L.marker([fire.lat, fire.lng], {icon: starIcon}).addTo(map);
                currentMarkers.push(marker);
            });
            
            fireCount = fires.length;
            updateStats(fireCount);
        }

        function updateStats(count) {
            if (count !== undefined) {
                fireCount = count;
            }
            document.getElementById('fireCount').textContent = fireCount;
        }

        // Обновляем кеш каждые 10 минут
        setInterval(loadAllFires, 10 * 60 * 1000);
    </script>
</body>
</html>
