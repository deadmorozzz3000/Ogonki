<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–û–≥–æ–Ω—å–∫–∏ –≤–µ—Ä—ã –≤ —á—É–¥–æ</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: #0a0a1a;
            color: white;
            overflow: hidden;
        }

        #map {
            height: 100vh;
            width: 100%;
            background: #1a1a2e;
        }

        .header {
            position: absolute;
            top: 15px;
            left: 15px;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px 20px;
            border-radius: 15px;
            border: 2px solid #FFD700;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 20px rgba(255, 215, 0, 0.3);
        }

        .header h1 {
            font-size: 18px;
            margin-bottom: 8px;
            color: #FFD700;
        }

        .stats {
            font-size: 14px;
        }

        .fire-count {
            color: #FFD700;
            font-weight: bold;
            font-size: 16px;
        }

        .instructions {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            padding: 12px 20px;
            border-radius: 10px;
            border: 1px solid #FFD700;
            z-index: 1000;
            font-size: 14px;
            text-align: center;
            backdrop-filter: blur(5px);
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –∑–≤—ë–∑–¥–æ—á–µ–∫ */
        .star-icon {
            font-size: 24px;
            filter: drop-shadow(0 0 8px rgba(255, 215, 0, 0.8));
            animation: gentle-glow 2s ease-in-out infinite alternate;
        }

        @keyframes gentle-glow {
            0% {
                filter: drop-shadow(0 0 4px rgba(255, 215, 0, 0.6));
                transform: scale(1);
            }
            100% {
                filter: drop-shadow(0 0 12px rgba(255, 215, 0, 1));
                transform: scale(1.1);
            }
        }

        /* –°–æ–æ–±—â–µ–Ω–∏—è */
        .message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.95);
            color: #FFD700;
            padding: 20px 30px;
            border-radius: 15px;
            border: 2px solid #FFD700;
            z-index: 10000;
            font-size: 16px;
            text-align: center;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.5);
            backdrop-filter: blur(10px);
        }

        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            color: #FFD700;
            padding: 25px;
            border-radius: 15px;
            border: 2px solid #FFD700;
            z-index: 1000;
            font-size: 16px;
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-width: 768px) {
            .header {
                top: 10px;
                left: 10px;
                right: 10px;
                text-align: center;
            }
            
            .instructions {
                bottom: 10px;
                left: 10px;
                right: 10px;
                transform: none;
            }
        }
    </style>
</head>
<body>
    <!-- –®–∞–ø–∫–∞ —Å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π -->
    <div class="header">
        <h1>‚ú® –û–≥–æ–Ω—å–∫–∏ –≤–µ—Ä—ã –≤ —á—É–¥–æ</h1>
        <div class="stats">
            –í—Å–µ–≥–æ –æ–≥–Ω–µ–π: <span class="fire-count" id="fireCount">0</span>
        </div>
    </div>

    <!-- –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è -->
    <div class="instructions">
        –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É –≤ –ª—é–±–æ–º –º–µ—Å—Ç–µ, —á—Ç–æ–±—ã –æ—Å—Ç–∞–≤–∏—Ç—å –æ–≥–æ–Ω—ë–∫ –≤–µ—Ä—ã ‚ú®
    </div>

    <!-- –ö–∞—Ä—Ç–∞ -->
    <div id="map"></div>

    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Leaflet -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è - –£–í–ï–õ–ò–ß–ò–õ–ò –°–ö–û–†–û–°–¢–¨ –û–ë–ù–û–í–õ–ï–ù–ò–Ø!
        const CONFIG = {
            API_URL: 'https://script.google.com/macros/s/AKfycbxUF6JdqzFvFVsF-YFuweyt_5EKKg4SCGHEbC7qjFTBSHclvr5mVVA5i5Z2HMfUxbA/exec',
            CACHE_DURATION: 30 * 1000, // 30 –°–ï–ö–£–ù–î –≤–º–µ—Å—Ç–æ 10 –º–∏–Ω—É—Ç!
            AUTO_REFRESH: 30 * 1000,   // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
            INITIAL_VIEW: [55.7558, 37.6173],
            INITIAL_ZOOM: 3
        };

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let map;
        let currentMarkers = [];
        let fireCount = 0;
        let lastUpdateTime = 0;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            initializeMap();
            loadFires();
            
            // –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–æ–≤—ã—Ö –æ–≥–æ–Ω—å–∫–æ–≤ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
            setInterval(quickCheckForNewFires, CONFIG.AUTO_REFRESH);
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã
        function initializeMap() {
            map = L.map('map').setView(CONFIG.INITIAL_VIEW, CONFIG.INITIAL_ZOOM);
            
            // –¢—ë–º–Ω–∞—è —Ç–µ–º–∞ –∫–∞—Ä—Ç—ã
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '¬© OpenStreetMap'
            }).addTo(map);

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –∫–∞—Ä—Ç–µ
            map.on('click', function(e) {
                addFire(e.latlng.lat, e.latlng.lng);
            });
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –∏–∫–æ–Ω–∫–∏ –∑–≤–µ–∑–¥—ã
        function createStarIcon() {
            return L.divIcon({
                className: 'star-icon',
                html: '‚ú®',
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            });
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ–≥–æ–Ω—å–∫–∞
        async function addFire(lat, lng) {
            showMessage("–°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–≥–æ–Ω—ë–∫... ‚ú®");
            
            try {
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä
                const result = await saveToServer(lat, lng);
                
                if (result && result.success) {
                    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞ –∫–∞—Ä—Ç—É
                    addMarkerToMap(lat, lng);
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
                    updateLocalStorage(lat, lng);
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á—ë—Ç—á–∏–∫
                    updateFireCount(fireCount + 1);
                    
                    showMessage("–û–≥–æ–Ω—ë–∫ —Å–æ—Ö—Ä–∞–Ω—ë–Ω! üåü", 1500);
                    
                    // –ë—ã—Å—Ç—Ä–æ –æ–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ —Å —Å–µ—Ä–≤–µ—Ä–∞ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
                    setTimeout(() => {
                        loadFires();
                    }, 2000);
                    
                } else {
                    throw new Error('–°–µ—Ä–≤–µ—Ä –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ');
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                showMessage("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑ üì°", 3000);
            }
        }

        // –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–æ–≤—ã—Ö –æ–≥–æ–Ω—å–∫–æ–≤ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –¥–∞–≤–Ω–æ –Ω–µ –æ–±–Ω–æ–≤–ª—è–ª–∏)
        async function quickCheckForNewFires() {
            // –ï—Å–ª–∏ –æ–±–Ω–æ–≤–ª—è–ª–∏—Å—å –º–µ–Ω—å—à–µ –º–∏–Ω—É—Ç—ã –Ω–∞–∑–∞–¥ - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
            if (Date.now() - lastUpdateTime < 60 * 1000) {
                return;
            }
            
            try {
                const fires = await loadFromServer();
                if (fires.length > fireCount) {
                    // –ï—Å—Ç—å –Ω–æ–≤—ã–µ –æ–≥–æ–Ω—å–∫–∏ - –æ–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ä—Ç—É
                    displayFires(fires);
                    saveToCache(fires);
                    showMessage(`+${fires.length - fireCount} –Ω–æ–≤—ã—Ö –æ–≥–æ–Ω—å–∫–æ–≤! ‚ú®`, 2000);
                }
            } catch (error) {
                console.log('–ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: –Ω–µ—Ç –Ω–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö');
            }
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        async function saveToServer(lat, lng) {
            const response = await fetch(CONFIG.API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ lat, lng })
            });
            
            return await response.json();
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–∞ –Ω–∞ –∫–∞—Ä—Ç—É
        function addMarkerToMap(lat, lng) {
            const marker = L.marker([lat, lng], { 
                icon: createStarIcon() 
            }).addTo(map);
            
            currentMarkers.push(marker);
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
        function updateLocalStorage(lat, lng) {
            const cachedData = getCachedFires();
            const fires = cachedData?.fires || [];
            
            // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –æ–≥–æ–Ω—ë–∫
            fires.push({ lat, lng });
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±—Ä–∞—Ç–Ω–æ
            localStorage.setItem('cachedFires', JSON.stringify({
                fires: fires,
                timestamp: Date.now()
            }));
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –æ–≥–æ–Ω—å–∫–æ–≤
        async function loadFires() {
            showLoading(true);
            
            // –ü—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ –∫–µ—à–∞ (–Ω–æ –∫–µ—à —Ç–µ–ø–µ—Ä—å –≤—Å–µ–≥–æ –Ω–∞ 30 —Å–µ–∫—É–Ω–¥)
            const cachedData = getCachedFires();
            if (cachedData && isCacheValid(cachedData.timestamp)) {
                displayFires(cachedData.fires);
                showLoading(false);
                
                // –§–æ–Ω–æ–≤–æ –≤—Å—ë —Ä–∞–≤–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–≤–µ–∂–∏–µ –¥–∞–Ω–Ω—ã–µ
                setTimeout(checkFreshData, 1000);
                return;
            }
            
            // –ï—Å–ª–∏ –∫–µ—à —É—Å—Ç–∞—Ä–µ–ª - –≥—Ä—É–∑–∏–º —Å —Å–µ—Ä–≤–µ—Ä–∞
            try {
                const fires = await loadFromServer();
                displayFires(fires);
                saveToCache(fires);
                lastUpdateTime = Date.now();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ä—ã–π –∫–µ—à –µ—Å–ª–∏ –µ—Å—Ç—å (–¥–∞–∂–µ –µ—Å–ª–∏ —É—Å—Ç–∞—Ä–µ–ª)
                if (cachedData) {
                    displayFires(cachedData.fires);
                    showMessage("–ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ", 2000);
                } else {
                    showMessage("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –æ–≥–Ω–∏", 3000);
                }
            }
            
            showLoading(false);
        }

        // –§–æ–Ω–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–≤–µ–∂–∏—Ö –¥–∞–Ω–Ω—ã—Ö
        async function checkFreshData() {
            try {
                const freshFires = await loadFromServer();
                const cachedData = getCachedFires();
                
                if (freshFires.length > (cachedData?.fires?.length || 0)) {
                    // –ù–∞—à–ª–∏ –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ - —Ç–∏—Ö–æ –æ–±–Ω–æ–≤–ª—è–µ–º
                    displayFires(freshFires);
                    saveToCache(freshFires);
                    console.log('–§–æ–Ω–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: –Ω–∞–π–¥–µ–Ω—ã –Ω–æ–≤—ã–µ –æ–≥–æ–Ω—å–∫–∏');
                }
            } catch (error) {
                // –¢–∏—Ö–∞—è –æ—à–∏–±–∫–∞ - –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å —Å–µ—Ä–≤–µ—Ä–∞
        async function loadFromServer() {
            const response = await fetch(CONFIG.API_URL + '?t=' + Date.now());
            return await response.json();
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        function getCachedFires() {
            const cached = localStorage.getItem('cachedFires');
            return cached ? JSON.parse(cached) : null;
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ –∫–µ—à–∞ (—Ç–µ–ø–µ—Ä—å –≤—Å–µ–≥–æ 30 —Å–µ–∫—É–Ω–¥!)
        function isCacheValid(timestamp) {
            return Date.now() - timestamp < CONFIG.CACHE_DURATION;
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –∫–µ—à
        function saveToCache(fires) {
            localStorage.setItem('cachedFires', JSON.stringify({
                fires: fires,
                timestamp: Date.now()
            }));
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ–≥–æ–Ω—å–∫–æ–≤ –Ω–∞ –∫–∞—Ä—Ç–µ
        function displayFires(fires) {
            // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –º–∞—Ä–∫–µ—Ä—ã
            clearMarkers();
            
            // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ
            fires.forEach(fire => {
                addMarkerToMap(fire.lat, fire.lng);
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á—ë—Ç—á–∏–∫
            updateFireCount(fires.length);
        }

        // –û—á–∏—Å—Ç–∫–∞ –º–∞—Ä–∫–µ—Ä–æ–≤
        function clearMarkers() {
            currentMarkers.forEach(marker => {
                map.removeLayer(marker);
            });
            currentMarkers = [];
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á—ë—Ç—á–∏–∫–∞
        function updateFireCount(count) {
            fireCount = count;
            document.getElementById('fireCount').textContent = count;
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –∑–∞–≥—Ä—É–∑–∫—É
        function showLoading(show) {
            let loading = document.getElementById('loading');
            
            if (show && !loading) {
                loading = document.createElement('div');
                loading.id = 'loading';
                loading.className = 'loading';
                loading.textContent = '–ó–∞–≥—Ä—É–∂–∞–µ–º –æ–≥–Ω–∏... ‚ú®';
                document.body.appendChild(loading);
            } else if (!show && loading) {
                loading.remove();
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
        function showMessage(text, duration = 3000) {
            const message = document.createElement('div');
            message.className = 'message';
            message.textContent = text;
            document.body.appendChild(message);
            
            setTimeout(() => {
                if (message.parentNode) {
                    message.parentNode.removeChild(message);
                }
            }, duration);
        }
    </script>
</body>
</html>
